#!/usr/bin/env bash
# Helper script for interactive debugging inside the base AWS container.
# Runs amazonlinux:2 with a shell so you can experiment with installing Node, nvm, etc.

set -euo pipefail
IFS=$'\n\t'

command="${1:-unset}"

if [[ ! -f ".env" ]]; then
  echo "Missing .env file. Copy .env-template and configure required values." >&2
  exit 1
fi

# shellcheck disable=SC1091
source .env

required_vars=(DOCKER_IMAGE_NAME DOCKER_IMAGE_TAG TF_VAR_CAT_ARCHITECTURE)
for var in "${required_vars[@]}"; do
  if [[ -z "${!var:-}" ]]; then
    echo "${var} must be set in .env" >&2
    exit 1
  fi
done

project_dir="$(pwd)"
image="${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
cat_arch="${TF_VAR_CAT_ARCHITECTURE:-x86_64}"
platform_opt=(--platform linux/amd64)
if [[ "${cat_arch}" == "arm64" ]]; then
  platform_opt=(--platform linux/arm64)
fi

case $command in
  shell)
    echo "Starting interactive shell in ${image}."
    docker run --rm -it "${image}" /bin/bash
    ;;
  *)
    echo "Usage: $0 [shell]"
    exit 1
    ;;
esac
