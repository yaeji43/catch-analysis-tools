#!/usr/bin/env bash
#
# Run locally inside the project Docker image.

set -euo pipefail
IFS=$'\n\t'

if [[ ! -f ".env" ]]; then
  echo "Missing .env file. Copy .env-template and configure required values." >&2
  exit 1
fi

# shellcheck disable=SC1091
source .env

required_vars=(DOCKER_IMAGE_NAME DOCKER_IMAGE_TAG TF_VAR_CAT_ARCHITECTURE)
for var in "${required_vars[@]}"; do
  if [[ -z "${!var:-}" ]]; then
    echo "${var} must be set in .env" >&2
    exit 1
  fi
done

project_dir="$(pwd)"
image="${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
lambda_arch="${TF_VAR_CAT_ARCHITECTURE:-x86_64}"
platform_opt=(--platform linux/amd64)
if [[ "${lambda_arch}" == "arm64" ]]; then
  platform_opt=(--platform linux/arm64)
fi

echo "Running inside ${image} (${platform_opt[0]})"

# hello_cmd=$'set -euo pipefail\nnode -v\nnode -e \'console.log("Lambda template hello world from " + process.version)\'\n'
run_cmd='python3 -m catch_analysis_tools'

set -x
docker run --rm --memory=1g "${platform_opt[@]}" \
  --volume "${project_dir}:/app" \
  --workdir /app \
  "${image}" \
  /bin/bash -lc "${run_cmd}"
set +x

echo "Container test completed."
